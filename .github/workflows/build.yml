name: Build and Deploy Praxiom Health App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: üîß Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: üì¶ Install dependencies
        run: npm install --legacy-peer-deps

      - name: üîë Initialize EAS Project
        run: eas init --id ${{ secrets.EXPO_PROJECT_ID }} --non-interactive
        continue-on-error: true

      # ============================================
      # DECODE AND SET APPLE API KEY
      # ============================================
      
      - name: üîê Prepare Apple API Key
        run: |
          # If your secret is base64 encoded, decode it
          echo "${{ secrets.APPLE_API_KEY }}" | base64 -d > /tmp/api-key.p8
          
          # Verify the file starts correctly
          head -n 1 /tmp/api-key.p8
          
          # Export as environment variable with proper format
          export EXPO_APPLE_APP_STORE_CONNECT_API_KEY_KEY=$(cat /tmp/api-key.p8)

      # ============================================
      # iOS BUILD
      # ============================================
      
      - name: üçé Build iOS App
        env:
          EXPO_APPLE_APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          EXPO_APPLE_APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          EXPO_APPLE_APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APPLE_API_KEY }}
        run: |
          # Debug: Verify environment variables are set
          echo "API Key ID is set: ${EXPO_APPLE_APP_STORE_CONNECT_API_KEY_KEY_ID:0:4}..."
          echo "Issuer ID is set: ${EXPO_APPLE_APP_STORE_CONNECT_API_KEY_ISSUER_ID:0:4}..."
          
          # Run the build
          eas build --platform ios --profile production --non-interactive
        
      - name: üöÄ Submit iOS to App Store Connect
        env:
          EXPO_APPLE_APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          EXPO_APPLE_APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          EXPO_APPLE_APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APPLE_API_KEY }}
        run: eas submit --platform ios --latest --non-interactive
        continue-on-error: true
        
      # ============================================
      # ANDROID BUILD
      # ============================================
      
      - name: ü§ñ Build Android App Bundle
        run: eas build --platform android --profile production --non-interactive

      # ============================================
      # CLEANUP
      # ============================================
      
      - name: üßπ Cleanup
        if: always()
        run: rm -f /tmp/api-key.p8

      # ============================================
      # NOTIFICATIONS
      # ============================================
      
      - name: ‚úÖ Notify Success
        if: success()
        run: |
          echo "‚úÖ Build completed successfully!"
          echo "üì± iOS app submitted to App Store Connect"
          echo "ü§ñ Android app bundle built"
          
      - name: ‚ùå Notify Failure
        if: failure()
        run: |
          echo "‚ùå Build failed. Check logs above."
