name: Build and Deploy Praxiom Health App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: üîß Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: üì¶ Install dependencies
        run: npm install --legacy-peer-deps

      - name: üîë Initialize EAS Project
        run: eas init --id ${{ secrets.EXPO_PROJECT_ID }} --non-interactive
        continue-on-error: true

      # ============================================
      # APPLE API KEY SETUP FOR NON-INTERACTIVE BUILD
      # ============================================
      
      - name: üîê Setup Apple API Key
        run: |
          echo "Setting up Apple API key for authentication..."
          mkdir -p ~/.appstoreconnect/private_keys
          echo "${{ secrets.APPLE_API_KEY }}" > ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APPLE_API_KEY_ID }}.p8
          echo "‚úÖ Apple API key configured"

      # ============================================
      # iOS BUILD AND SUBMIT TO APP STORE CONNECT
      # ============================================
      
      - name: üçé Build iOS App
        env:
          EXPO_APPLE_API_KEY_PATH: ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APPLE_API_KEY_ID }}.p8
          EXPO_APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          EXPO_APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
        run: eas build --platform ios --profile production --non-interactive
        
      - name: üöÄ Submit iOS to App Store Connect
        env:
          EXPO_APPLE_API_KEY_PATH: ~/.appstoreconnect/private_keys/AuthKey_${{ secrets.APPLE_API_KEY_ID }}.p8
          EXPO_APPLE_API_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          EXPO_APPLE_API_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
        run: eas submit --platform ios --latest --non-interactive
        continue-on-error: true  # Don't fail if submit has issues
        
      # ============================================
      # ANDROID BUILD
      # ============================================
      
      - name: ü§ñ Build Android APK
        run: eas build --platform android --profile preview --non-interactive

      # ============================================
      # NOTIFICATIONS (OPTIONAL)
      # ============================================
      
      - name: ‚úÖ Notify Success
        if: success()
        run: |
          echo "‚úÖ Build completed successfully!"
          echo "üì± iOS app submitted to App Store Connect"
          echo "ü§ñ Android APK built"
          
      - name: ‚ùå Notify Failure
        if: failure()
        run: |
          echo "‚ùå Build failed. Check logs above."
