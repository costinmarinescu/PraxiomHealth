name: Build and Deploy Praxiom Health App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v3

      - name: üü¢ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: üîß Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: üì¶ Install dependencies
        run: npm install --legacy-peer-deps

      - name: üîë Initialize EAS Project
        run: eas init --id ${{ secrets.EXPO_PROJECT_ID }} --non-interactive
        continue-on-error: true

      # ============================================
      # iOS BUILD WITH CORRECT ENV VARS FOR EAS
      # ============================================
      
      - name: üçé Build iOS App
        env:
          # These are the EXACT variable names EAS expects
          EXPO_APPLE_APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          EXPO_APPLE_APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          EXPO_APPLE_APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APPLE_API_KEY }}
        run: eas build --platform ios --profile production --non-interactive
        
      - name: üöÄ Submit iOS to App Store Connect
        env:
          EXPO_APPLE_APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APPLE_API_KEY_ID }}
          EXPO_APPLE_APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APPLE_API_ISSUER_ID }}
          EXPO_APPLE_APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APPLE_API_KEY }}
        run: eas submit --platform ios --latest --non-interactive
        continue-on-error: true
        
      # ============================================
      # ANDROID BUILD
      # ============================================
      
      - name: ü§ñ Build Android App Bundle
        run: eas build --platform android --profile production --non-interactive

      # ============================================
      # NOTIFICATIONS (OPTIONAL)
      # ============================================
      
      - name: ‚úÖ Notify Success
        if: success()
        run: |
          echo "‚úÖ Build completed successfully!"
          echo "üì± iOS app submitted to App Store Connect"
          echo "ü§ñ Android app bundle built"
          
      - name: ‚ùå Notify Failure
        if: failure()
        run: |
          echo "‚ùå Build failed. Check logs above."
